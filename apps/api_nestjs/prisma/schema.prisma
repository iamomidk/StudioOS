generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum MembershipRole {
  owner
  manager
  shooter
  editor
  renter
  client
}

enum LeadStatus {
  new
  contacted
  qualified
  converted
  archived
}

enum BookingStatus {
  draft
  confirmed
  cancelled
  completed
}

enum QuoteStatus {
  draft
  sent
  accepted
  rejected
  expired
}

enum ProjectStatus {
  preprod
  shoot
  edit
  review
  delivered
  closed
}

enum ClientApprovalState {
  pending
  approved
  changes_requested
}

enum AssetCondition {
  excellent
  good
  fair
  damaged
}

enum RentalOrderStatus {
  reserved
  picked_up
  returned
  incident
  cancelled
}

enum InvoiceStatus {
  draft
  issued
  partially_paid
  paid
  overdue
  cancelled
}

enum PaymentStatus {
  pending
  succeeded
  failed
  refunded
}

enum ExperimentStatus {
  draft
  active
  paused
  stopped
}

enum AllocationTargetType {
  all
  organization
  cohort
}

enum SupportTicketStatus {
  open
  triaged
  in_progress
  resolved
  closed
}

enum SupportTicketSeverity {
  p0
  p1
  p2
  p3
}

enum SlaBreachState {
  healthy
  at_risk
  breached
  recovered
}

enum ReconciliationRunStatus {
  completed
  failed
}

enum ReconciliationItemStatus {
  matched
  discrepant
}

enum ReconciliationDiscrepancyType {
  MissingInternalRecord
  MissingProviderRecord
  AmountMismatch
  CurrencyMismatch
  StatusMismatch
  DuplicateChargeSuspected
}

enum ReconciliationDiscrepancyStatus {
  open
  acknowledged
  resolved
}

enum RiskScoringMode {
  OFF
  ADVISORY
  SOFT_ENFORCE
  HARD_ENFORCE
}

enum RiskLevel {
  low
  medium
  high
}

enum PartnerCredentialStatus {
  active
  suspended
  revoked
}

model User {
  id             String              @id @default(cuid())
  email          String              @unique
  firstName      String
  lastName       String
  passwordHash   String              @default("")
  mfaEnabled     Boolean             @default(false)
  deactivatedAt  DateTime?
  deletedAt      DateTime?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  memberships    Membership[]
  projects       Project[]
  rentalOrders   RentalOrder[]
  payments       Payment[]
  auditLogs      AuditLog[]
  refreshTokens  RefreshToken[]
  rentalEvidence RentalEvidence[]
  supportTickets SupportTicket[]
  supportNotes   SupportTicketNote[]
  reconciliationRunsTriggered      ReconciliationRun[]         @relation("ReconciliationRunTriggeredBy")
  reconciliationDiscrepanciesOwned ReconciliationDiscrepancy[] @relation("ReconciliationOwner")
  reconciliationDiscrepanciesAcked ReconciliationDiscrepancy[] @relation("ReconciliationAcknowledgedBy")
  reconciliationDiscrepanciesResolved ReconciliationDiscrepancy[] @relation("ReconciliationResolvedBy")
  reconciliationActions            ReconciliationActionLog[]
  riskEvaluations                 RiskEvaluation[]
  complianceExportRecords         ComplianceExportRecord[]
  purgeRequestsRequested          EnterprisePurgeRequest[] @relation("EnterprisePurgeRequestRequestedBy")
  purgeRequestsApproved           EnterprisePurgeRequest[] @relation("EnterprisePurgeRequestApprovedBy")
  purgeRequestsTarget             EnterprisePurgeRequest[] @relation("EnterprisePurgeRequestTargetUser")
}

model RefreshToken {
  id         String    @id @default(cuid())
  userId     String
  tokenHash  String    @unique
  jti        String    @unique
  expiresAt  DateTime
  revokedAt  DateTime?
  createdAt  DateTime  @default(now())
  replacedBy String?
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
}

model Organization {
  id                   String                @id @default(cuid())
  name                 String
  pilotOrg             Boolean               @default(false)
  pilotCohortId        String?
  ssoEnforced          Boolean               @default(false)
  ssoProvider          String?
  ssoDomains           String[]
  enterpriseScimEnabled Boolean             @default(false)
  sessionDurationMinutes Int                @default(10080)
  mfaEnforced          Boolean               @default(false)
  ipAllowlist          String[]
  retentionDays        Int                   @default(365)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  memberships          Membership[]
  clients              Client[]
  leads                Lead[]
  quotes               Quote[]
  bookings             Booking[]
  projects             Project[]
  assets               Asset[]
  inventoryItems       InventoryItem[]
  rentalOrders         RentalOrder[]
  invoices             Invoice[]
  payments             Payment[]
  paymentWebhookEvents PaymentWebhookEvent[]
  auditLogs            AuditLog[]
  rentalEvidence       RentalEvidence[]
  analyticsEvents      AnalyticsEvent[]
  pricingExposureLogs  PricingExposureLog[]
  supportTickets       SupportTicket[]
  reconciliationRuns   ReconciliationRun[]
  reconciliationItems  ReconciliationItem[]
  reconciliationDiscrepancies ReconciliationDiscrepancy[]
  reconciliationActionLogs    ReconciliationActionLog[]
  riskEvaluations             RiskEvaluation[]
  partnerCredentials          PartnerApiCredential[]
  partnerRequestLogs          PartnerApiRequestLog[]
  partnerIdempotencyRecords   PartnerApiIdempotencyRecord[]
  complianceExportRecords      ComplianceExportRecord[]
  purgeRequests               EnterprisePurgeRequest[]
}

model Membership {
  id             String         @id @default(cuid())
  organizationId String
  userId         String
  role           MembershipRole
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([userId])
}

model Client {
  id             String        @id @default(cuid())
  organizationId String
  name           String
  email          String?
  phone          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  bookings       Booking[]
  quotes         Quote[]
  projects       Project[]
  invoices       Invoice[]
  rentalOrders   RentalOrder[]

  @@index([organizationId])
}

model Lead {
  id             String       @id @default(cuid())
  organizationId String
  name           String
  email          String?
  phone          String?
  source         String?
  status         LeadStatus   @default(new)
  convertedAt    DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, status])
}

model Booking {
  id             String        @id @default(cuid())
  organizationId String
  clientId       String
  quoteId        String?       @unique
  title          String
  startsAt       DateTime
  endsAt         DateTime
  status         BookingStatus @default(draft)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client         Client        @relation(fields: [clientId], references: [id], onDelete: Restrict)
  quote          Quote?        @relation(fields: [quoteId], references: [id], onDelete: SetNull)
  projects       Project[]

  @@index([organizationId, startsAt, endsAt])
}

model Quote {
  id             String          @id @default(cuid())
  organizationId String
  clientId       String
  title          String
  status         QuoteStatus     @default(draft)
  startsAt       DateTime
  endsAt         DateTime
  subtotalCents  Int
  taxCents       Int             @default(0)
  totalCents     Int
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client         Client          @relation(fields: [clientId], references: [id], onDelete: Restrict)
  booking        Booking?
  lineItems      QuoteLineItem[]

  @@index([organizationId, status])
}

model QuoteLineItem {
  id             String   @id @default(cuid())
  quoteId        String
  description    String
  quantity       Int
  unitPriceCents Int
  lineTotalCents Int
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  quote          Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
}

model Project {
  id                  String              @id @default(cuid())
  organizationId      String
  bookingId           String?
  clientId            String
  ownerUserId         String?
  name                String
  status              ProjectStatus       @default(preprod)
  clientApprovalState ClientApprovalState @default(pending)
  revisionCount       Int                 @default(0)
  lastRevisionComment String?
  clientApprovedAt    DateTime?
  dueAt               DateTime?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  organization        Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  booking             Booking?            @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  client              Client              @relation(fields: [clientId], references: [id], onDelete: Restrict)
  owner               User?               @relation(fields: [ownerUserId], references: [id], onDelete: SetNull)

  @@index([organizationId, status])
}

model Asset {
  id             String          @id @default(cuid())
  organizationId String
  name           String
  category       String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  inventoryItems InventoryItem[]

  @@index([organizationId, category])
}

model InventoryItem {
  id             String         @id @default(cuid())
  organizationId String
  assetId        String
  serialNumber   String
  condition      AssetCondition @default(good)
  ownerName      String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  asset          Asset          @relation(fields: [assetId], references: [id], onDelete: Restrict)
  rentalOrders   RentalOrder[]

  @@unique([organizationId, serialNumber])
  @@index([organizationId, condition])
}

model RentalOrder {
  id              String            @id @default(cuid())
  organizationId  String
  inventoryItemId String
  clientId        String?
  assignedUserId  String?
  startsAt        DateTime
  endsAt          DateTime
  status          RentalOrderStatus @default(reserved)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  organization    Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  inventoryItem   InventoryItem     @relation(fields: [inventoryItemId], references: [id], onDelete: Restrict)
  client          Client?           @relation(fields: [clientId], references: [id], onDelete: SetNull)
  assignedUser    User?             @relation(fields: [assignedUserId], references: [id], onDelete: SetNull)
  evidence        RentalEvidence[]

  @@index([organizationId, status])
}

model RentalEvidence {
  id             String       @id @default(cuid())
  organizationId String
  rentalOrderId  String
  actorUserId    String?
  photoUrl       String
  note           String
  occurredAt     DateTime
  latitude       Float?
  longitude      Float?
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  rentalOrder    RentalOrder  @relation(fields: [rentalOrderId], references: [id], onDelete: Cascade)
  actor          User?        @relation(fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([organizationId, rentalOrderId, occurredAt])
}

model Invoice {
  id             String                @id @default(cuid())
  organizationId String
  clientId       String
  invoiceNumber  String
  status         InvoiceStatus         @default(draft)
  subtotalCents  Int
  taxCents       Int
  totalCents     Int
  issuedAt       DateTime?
  dueAt          DateTime?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  organization   Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client         Client                @relation(fields: [clientId], references: [id], onDelete: Restrict)
  payments       Payment[]
  webhookEvents  PaymentWebhookEvent[]
  reconciliationItems        ReconciliationItem[]
  reconciliationDiscrepancies ReconciliationDiscrepancy[]

  @@unique([organizationId, invoiceNumber])
  @@index([organizationId, status])
}

model Payment {
  id             String                @id @default(cuid())
  organizationId String
  invoiceId      String
  userId         String?
  provider       String
  providerRef    String?
  amountCents    Int
  currency       String                @default("USD")
  status         PaymentStatus         @default(pending)
  paidAt         DateTime?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  organization   Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoice        Invoice               @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  user           User?                 @relation(fields: [userId], references: [id], onDelete: SetNull)
  webhookEvents  PaymentWebhookEvent[]
  reconciliationItems        ReconciliationItem[]
  reconciliationDiscrepancies ReconciliationDiscrepancy[]

  @@index([organizationId, status])
}

model PaymentWebhookEvent {
  id             String       @id @default(cuid())
  provider       String
  eventId        String
  organizationId String
  invoiceId      String
  paymentId      String?
  payload        Json
  processedAt    DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoice        Invoice      @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  payment        Payment?     @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  reconciliationItems ReconciliationItem[]
  reconciliationDiscrepancies ReconciliationDiscrepancy[]

  @@unique([provider, eventId])
  @@index([organizationId, invoiceId, processedAt])
}

model ReconciliationRun {
  id                   String                 @id @default(cuid())
  organizationId       String
  periodStart          DateTime
  periodEnd            DateTime
  status               ReconciliationRunStatus @default(completed)
  totalInternalRecords Int                    @default(0)
  totalProviderRecords Int                    @default(0)
  matchedCount         Int                    @default(0)
  discrepancyCount     Int                    @default(0)
  mismatchAmountCents  Int                    @default(0)
  reportJson           Json?
  reportMarkdown       String?
  triggeredByUserId    String?
  createdAt            DateTime               @default(now())
  completedAt          DateTime?
  organization         Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  triggeredBy          User?                  @relation("ReconciliationRunTriggeredBy", fields: [triggeredByUserId], references: [id], onDelete: SetNull)
  items                ReconciliationItem[]
  discrepancies        ReconciliationDiscrepancy[]
  actionLogs           ReconciliationActionLog[]

  @@index([organizationId, createdAt])
}

model ReconciliationItem {
  id                 String                     @id @default(cuid())
  runId              String
  organizationId     String
  invoiceId          String?
  paymentId          String?
  providerEventId    String?
  providerRef        String?
  internalAmountCents Int?
  providerAmountCents Int?
  currency           String?
  status             ReconciliationItemStatus   @default(matched)
  discrepancyType    ReconciliationDiscrepancyType?
  createdAt          DateTime                   @default(now())
  run                ReconciliationRun          @relation(fields: [runId], references: [id], onDelete: Cascade)
  organization       Organization               @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoice            Invoice?                   @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  payment            Payment?                   @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  providerEvent      PaymentWebhookEvent?       @relation(fields: [providerEventId], references: [id], onDelete: SetNull)
  discrepancy        ReconciliationDiscrepancy?

  @@index([runId, status])
  @@index([organizationId, invoiceId])
}

model ReconciliationDiscrepancy {
  id                 String                         @id @default(cuid())
  runId              String
  itemId             String?                        @unique
  organizationId     String
  invoiceId          String?
  paymentId          String?
  providerEventId    String?
  type               ReconciliationDiscrepancyType
  status             ReconciliationDiscrepancyStatus @default(open)
  ownerUserId        String?
  acknowledgedByUserId String?
  acknowledgedAt     DateTime?
  resolvedByUserId   String?
  resolvedAt         DateTime?
  resolutionReason   String?
  notes              String?
  amountDeltaCents   Int?
  createdAt          DateTime                       @default(now())
  updatedAt          DateTime                       @updatedAt
  run                ReconciliationRun              @relation(fields: [runId], references: [id], onDelete: Cascade)
  item               ReconciliationItem?            @relation(fields: [itemId], references: [id], onDelete: SetNull)
  organization       Organization                   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoice            Invoice?                       @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  payment            Payment?                       @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  providerEvent      PaymentWebhookEvent?          @relation(fields: [providerEventId], references: [id], onDelete: SetNull)
  owner              User?                          @relation("ReconciliationOwner", fields: [ownerUserId], references: [id], onDelete: SetNull)
  acknowledgedBy     User?                          @relation("ReconciliationAcknowledgedBy", fields: [acknowledgedByUserId], references: [id], onDelete: SetNull)
  resolvedBy         User?                          @relation("ReconciliationResolvedBy", fields: [resolvedByUserId], references: [id], onDelete: SetNull)
  actionLogs         ReconciliationActionLog[]

  @@index([runId, status, type])
  @@index([organizationId, createdAt])
}

model ReconciliationActionLog {
  id              String            @id @default(cuid())
  runId           String
  discrepancyId   String?
  organizationId  String
  actorUserId     String?
  action          String
  note            String?
  metadata        Json?
  createdAt       DateTime          @default(now())
  run             ReconciliationRun @relation(fields: [runId], references: [id], onDelete: Cascade)
  discrepancy     ReconciliationDiscrepancy? @relation(fields: [discrepancyId], references: [id], onDelete: SetNull)
  organization    Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  actor           User?             @relation(fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([runId, createdAt])
  @@index([organizationId, createdAt])
}

model RiskEvaluation {
  id               String          @id @default(cuid())
  organizationId   String
  userId           String?
  flowType         String
  entityType       String?
  entityId         String?
  mode             RiskScoringMode
  riskScore        Int
  riskLevel        RiskLevel
  reasonCodes      String[]
  actionTaken      String
  blocked          Boolean         @default(false)
  bypassed         Boolean         @default(false)
  pilotCohortId    String?
  reviewStatus     String          @default("pending")
  reviewNote       String?
  createdAt        DateTime        @default(now())
  organization     Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user             User?           @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([organizationId, createdAt])
  @@index([flowType, riskLevel, createdAt])
  @@index([reviewStatus, createdAt])
}

model PartnerApiCredential {
  id                    String                  @id @default(cuid())
  organizationId        String
  name                  String
  keyId                 String                  @unique
  keyHash               String
  scopes                String[]
  status                PartnerCredentialStatus @default(active)
  requestsPerMinute     Int                     @default(120)
  dailyQuota            Int                     @default(10000)
  requestSigningRequired Boolean                @default(false)
  signingSecret         String?
  rotatedFromId         String?
  lastUsedAt            DateTime?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  organization          Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  requestLogs           PartnerApiRequestLog[]
  idempotencyRecords    PartnerApiIdempotencyRecord[]

  @@index([organizationId, status])
}

model PartnerApiRequestLog {
  id            String               @id @default(cuid())
  organizationId String
  credentialId  String
  method        String
  path          String
  statusCode    Int
  latencyMs     Int
  createdAt     DateTime             @default(now())
  organization  Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  credential    PartnerApiCredential @relation(fields: [credentialId], references: [id], onDelete: Cascade)

  @@index([credentialId, createdAt])
  @@index([organizationId, createdAt])
}

model PartnerApiIdempotencyRecord {
  id             String               @id @default(cuid())
  organizationId String
  credentialId   String
  method         String
  path           String
  idempotencyKey String
  requestHash    String
  statusCode     Int
  responseBody   Json
  createdAt      DateTime             @default(now())
  organization   Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  credential     PartnerApiCredential @relation(fields: [credentialId], references: [id], onDelete: Cascade)

  @@unique([credentialId, method, path, idempotencyKey])
  @@index([organizationId, createdAt])
}

model ComplianceExportRecord {
  id             String       @id @default(cuid())
  organizationId String
  actorUserId    String?
  exportType     String
  dateFrom       DateTime?
  dateTo         DateTime?
  rowCount       Int          @default(0)
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  actor          User?        @relation(fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([organizationId, exportType, createdAt])
}

model EnterprisePurgeRequest {
  id               String       @id @default(cuid())
  organizationId   String
  targetUserId     String
  requestedByUserId String
  approvedByUserId String?
  status           String       @default("pending")
  reason           String
  approvalReason   String?
  requestedAt      DateTime     @default(now())
  approvedAt       DateTime?
  executedAt       DateTime?
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  targetUser       User         @relation("EnterprisePurgeRequestTargetUser", fields: [targetUserId], references: [id], onDelete: Cascade)
  requestedBy      User         @relation("EnterprisePurgeRequestRequestedBy", fields: [requestedByUserId], references: [id], onDelete: Cascade)
  approvedBy       User?        @relation("EnterprisePurgeRequestApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)

  @@index([organizationId, status, requestedAt])
}

model AuditLog {
  id             String       @id @default(cuid())
  organizationId String
  actorUserId    String?
  entityType     String
  entityId       String
  action         String
  metadata       Json?
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  actor          User?        @relation(fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([organizationId, entityType, entityId])
  @@index([createdAt])
}

model AnalyticsEvent {
  id              String                       @id @default(cuid())
  organizationId  String
  eventName       String
  actorRole       String
  source          String
  entityType      String?
  entityId        String?
  payload         Json?
  idempotencyKey  String?                      @unique
  occurredAt      DateTime
  pilotOrg        Boolean                      @default(false)
  pilotCohortId   String?
  createdAt       DateTime                     @default(now())
  organization    Organization                 @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  conversionLinks PricingConversionEventLink[]

  @@index([organizationId, eventName, occurredAt])
  @@index([pilotOrg, pilotCohortId, occurredAt])
}

model PricingExperiment {
  id                String                  @id @default(cuid())
  key               String                  @unique
  name              String
  description       String?
  status            ExperimentStatus        @default(draft)
  startsAt          DateTime?
  endsAt            DateTime?
  killSwitchEnabled Boolean                 @default(false)
  maxExposure       Int?
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  variants          PricingVariant[]
  allocationRules   PricingAllocationRule[]
  exposureLogs      PricingExposureLog[]

  @@index([status, startsAt, endsAt])
}

model PricingVariant {
  id                String               @id @default(cuid())
  experimentId      String
  key               String
  name              String
  weight            Int                  @default(1)
  pricingMultiplier Float?
  config            Json?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  experiment        PricingExperiment    @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  exposureLogs      PricingExposureLog[]

  @@unique([experimentId, key])
  @@index([experimentId])
}

model PricingAllocationRule {
  id           String               @id @default(cuid())
  experimentId String
  targetType   AllocationTargetType
  targetValue  String?
  createdAt    DateTime             @default(now())
  experiment   PricingExperiment    @relation(fields: [experimentId], references: [id], onDelete: Cascade)

  @@index([experimentId, targetType, targetValue])
}

model PricingExposureLog {
  id              String                       @id @default(cuid())
  experimentId    String
  variantId       String
  organizationId  String
  subjectType     String
  subjectKey      String
  source          String
  entityType      String?
  entityId        String?
  idempotencyKey  String?                      @unique
  occurredAt      DateTime                     @default(now())
  createdAt       DateTime                     @default(now())
  experiment      PricingExperiment            @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  variant         PricingVariant               @relation(fields: [variantId], references: [id], onDelete: Cascade)
  organization    Organization                 @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  conversionLinks PricingConversionEventLink[]

  @@index([experimentId, variantId, occurredAt])
  @@index([organizationId, occurredAt])
  @@index([subjectType, subjectKey, occurredAt])
  @@index([entityType, entityId, occurredAt])
}

model PricingConversionEventLink {
  id               String             @id @default(cuid())
  exposureLogId    String
  analyticsEventId String
  eventName        String
  entityType       String?
  entityId         String?
  occurredAt       DateTime
  createdAt        DateTime           @default(now())
  exposureLog      PricingExposureLog @relation(fields: [exposureLogId], references: [id], onDelete: Cascade)
  analyticsEvent   AnalyticsEvent     @relation(fields: [analyticsEventId], references: [id], onDelete: Cascade)

  @@unique([exposureLogId, analyticsEventId])
  @@index([eventName, occurredAt])
}

model SupportTicket {
  id             String                @id @default(cuid())
  organizationId String
  reporterUserId String?
  title          String
  description    String
  status         SupportTicketStatus   @default(open)
  severity       SupportTicketSeverity @default(p2)
  routePath      String?
  screenName     String?
  appVersion     String?
  correlationId  String?
  requestId      String?
  attachments    Json?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  resolvedAt     DateTime?
  organization   Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  reporter       User?                 @relation(fields: [reporterUserId], references: [id], onDelete: SetNull)
  notes          SupportTicketNote[]
  sla            SupportTicketSla?

  @@index([organizationId, status, severity, createdAt])
  @@index([reporterUserId, createdAt])
}

model SupportTicketNote {
  id           String        @id @default(cuid())
  ticketId     String
  authorUserId String?
  note         String
  createdAt    DateTime      @default(now())
  ticket       SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  author       User?         @relation(fields: [authorUserId], references: [id], onDelete: SetNull)

  @@index([ticketId, createdAt])
}

model SupportTicketSla {
  id                         String         @id @default(cuid())
  ticketId                   String         @unique
  policyVersion              String
  businessHoursOnly          Boolean        @default(false)
  firstResponseTargetMinutes Int
  resolutionTargetMinutes    Int
  clockStartedAt             DateTime
  firstResponseDueAt         DateTime
  resolutionDueAt            DateTime
  firstResponseAt            DateTime?
  resolvedAt                 DateTime?
  firstResponseBreachedAt    DateTime?
  resolutionBreachedAt       DateTime?
  state                      SlaBreachState @default(healthy)
  pausedAt                   DateTime?
  totalPausedSeconds         Int            @default(0)
  lastEvaluatedAt            DateTime       @default(now())
  createdAt                  DateTime       @default(now())
  updatedAt                  DateTime       @updatedAt
  ticket                     SupportTicket  @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([state, lastEvaluatedAt])
  @@index([clockStartedAt, resolutionDueAt])
}
