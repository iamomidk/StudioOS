generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum MembershipRole {
  owner
  manager
  shooter
  editor
  renter
  client
}

enum LeadStatus {
  new
  contacted
  qualified
  converted
  archived
}

enum BookingStatus {
  draft
  confirmed
  cancelled
  completed
}

enum QuoteStatus {
  draft
  sent
  accepted
  rejected
  expired
}

enum ProjectStatus {
  preprod
  shoot
  edit
  review
  delivered
  closed
}

enum ClientApprovalState {
  pending
  approved
  changes_requested
}

enum AssetCondition {
  excellent
  good
  fair
  damaged
}

enum RentalOrderStatus {
  reserved
  picked_up
  returned
  incident
  cancelled
}

enum InvoiceStatus {
  draft
  issued
  partially_paid
  paid
  overdue
  cancelled
}

enum PaymentStatus {
  pending
  succeeded
  failed
  refunded
}

enum ExperimentStatus {
  draft
  active
  paused
  stopped
}

enum AllocationTargetType {
  all
  organization
  cohort
}

enum SupportTicketStatus {
  open
  triaged
  in_progress
  resolved
  closed
}

enum SupportTicketSeverity {
  p0
  p1
  p2
  p3
}

enum SlaBreachState {
  healthy
  at_risk
  breached
  recovered
}

model User {
  id             String              @id @default(cuid())
  email          String              @unique
  firstName      String
  lastName       String
  passwordHash   String              @default("")
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  memberships    Membership[]
  projects       Project[]
  rentalOrders   RentalOrder[]
  payments       Payment[]
  auditLogs      AuditLog[]
  refreshTokens  RefreshToken[]
  rentalEvidence RentalEvidence[]
  supportTickets SupportTicket[]
  supportNotes   SupportTicketNote[]
}

model RefreshToken {
  id         String    @id @default(cuid())
  userId     String
  tokenHash  String    @unique
  jti        String    @unique
  expiresAt  DateTime
  revokedAt  DateTime?
  createdAt  DateTime  @default(now())
  replacedBy String?
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
}

model Organization {
  id                   String                @id @default(cuid())
  name                 String
  pilotOrg             Boolean               @default(false)
  pilotCohortId        String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  memberships          Membership[]
  clients              Client[]
  leads                Lead[]
  quotes               Quote[]
  bookings             Booking[]
  projects             Project[]
  assets               Asset[]
  inventoryItems       InventoryItem[]
  rentalOrders         RentalOrder[]
  invoices             Invoice[]
  payments             Payment[]
  paymentWebhookEvents PaymentWebhookEvent[]
  auditLogs            AuditLog[]
  rentalEvidence       RentalEvidence[]
  analyticsEvents      AnalyticsEvent[]
  pricingExposureLogs  PricingExposureLog[]
  supportTickets       SupportTicket[]
}

model Membership {
  id             String         @id @default(cuid())
  organizationId String
  userId         String
  role           MembershipRole
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([userId])
}

model Client {
  id             String        @id @default(cuid())
  organizationId String
  name           String
  email          String?
  phone          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  bookings       Booking[]
  quotes         Quote[]
  projects       Project[]
  invoices       Invoice[]
  rentalOrders   RentalOrder[]

  @@index([organizationId])
}

model Lead {
  id             String       @id @default(cuid())
  organizationId String
  name           String
  email          String?
  phone          String?
  source         String?
  status         LeadStatus   @default(new)
  convertedAt    DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, status])
}

model Booking {
  id             String        @id @default(cuid())
  organizationId String
  clientId       String
  quoteId        String?       @unique
  title          String
  startsAt       DateTime
  endsAt         DateTime
  status         BookingStatus @default(draft)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client         Client        @relation(fields: [clientId], references: [id], onDelete: Restrict)
  quote          Quote?        @relation(fields: [quoteId], references: [id], onDelete: SetNull)
  projects       Project[]

  @@index([organizationId, startsAt, endsAt])
}

model Quote {
  id             String          @id @default(cuid())
  organizationId String
  clientId       String
  title          String
  status         QuoteStatus     @default(draft)
  startsAt       DateTime
  endsAt         DateTime
  subtotalCents  Int
  taxCents       Int             @default(0)
  totalCents     Int
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client         Client          @relation(fields: [clientId], references: [id], onDelete: Restrict)
  booking        Booking?
  lineItems      QuoteLineItem[]

  @@index([organizationId, status])
}

model QuoteLineItem {
  id             String   @id @default(cuid())
  quoteId        String
  description    String
  quantity       Int
  unitPriceCents Int
  lineTotalCents Int
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  quote          Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
}

model Project {
  id                  String              @id @default(cuid())
  organizationId      String
  bookingId           String?
  clientId            String
  ownerUserId         String?
  name                String
  status              ProjectStatus       @default(preprod)
  clientApprovalState ClientApprovalState @default(pending)
  revisionCount       Int                 @default(0)
  lastRevisionComment String?
  clientApprovedAt    DateTime?
  dueAt               DateTime?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  organization        Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  booking             Booking?            @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  client              Client              @relation(fields: [clientId], references: [id], onDelete: Restrict)
  owner               User?               @relation(fields: [ownerUserId], references: [id], onDelete: SetNull)

  @@index([organizationId, status])
}

model Asset {
  id             String          @id @default(cuid())
  organizationId String
  name           String
  category       String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  inventoryItems InventoryItem[]

  @@index([organizationId, category])
}

model InventoryItem {
  id             String         @id @default(cuid())
  organizationId String
  assetId        String
  serialNumber   String
  condition      AssetCondition @default(good)
  ownerName      String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  asset          Asset          @relation(fields: [assetId], references: [id], onDelete: Restrict)
  rentalOrders   RentalOrder[]

  @@unique([organizationId, serialNumber])
  @@index([organizationId, condition])
}

model RentalOrder {
  id              String            @id @default(cuid())
  organizationId  String
  inventoryItemId String
  clientId        String?
  assignedUserId  String?
  startsAt        DateTime
  endsAt          DateTime
  status          RentalOrderStatus @default(reserved)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  organization    Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  inventoryItem   InventoryItem     @relation(fields: [inventoryItemId], references: [id], onDelete: Restrict)
  client          Client?           @relation(fields: [clientId], references: [id], onDelete: SetNull)
  assignedUser    User?             @relation(fields: [assignedUserId], references: [id], onDelete: SetNull)
  evidence        RentalEvidence[]

  @@index([organizationId, status])
}

model RentalEvidence {
  id             String       @id @default(cuid())
  organizationId String
  rentalOrderId  String
  actorUserId    String?
  photoUrl       String
  note           String
  occurredAt     DateTime
  latitude       Float?
  longitude      Float?
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  rentalOrder    RentalOrder  @relation(fields: [rentalOrderId], references: [id], onDelete: Cascade)
  actor          User?        @relation(fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([organizationId, rentalOrderId, occurredAt])
}

model Invoice {
  id             String                @id @default(cuid())
  organizationId String
  clientId       String
  invoiceNumber  String
  status         InvoiceStatus         @default(draft)
  subtotalCents  Int
  taxCents       Int
  totalCents     Int
  issuedAt       DateTime?
  dueAt          DateTime?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  organization   Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client         Client                @relation(fields: [clientId], references: [id], onDelete: Restrict)
  payments       Payment[]
  webhookEvents  PaymentWebhookEvent[]

  @@unique([organizationId, invoiceNumber])
  @@index([organizationId, status])
}

model Payment {
  id             String                @id @default(cuid())
  organizationId String
  invoiceId      String
  userId         String?
  provider       String
  providerRef    String?
  amountCents    Int
  currency       String                @default("USD")
  status         PaymentStatus         @default(pending)
  paidAt         DateTime?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  organization   Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoice        Invoice               @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  user           User?                 @relation(fields: [userId], references: [id], onDelete: SetNull)
  webhookEvents  PaymentWebhookEvent[]

  @@index([organizationId, status])
}

model PaymentWebhookEvent {
  id             String       @id @default(cuid())
  provider       String
  eventId        String
  organizationId String
  invoiceId      String
  paymentId      String?
  payload        Json
  processedAt    DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoice        Invoice      @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  payment        Payment?     @relation(fields: [paymentId], references: [id], onDelete: SetNull)

  @@unique([provider, eventId])
  @@index([organizationId, invoiceId, processedAt])
}

model AuditLog {
  id             String       @id @default(cuid())
  organizationId String
  actorUserId    String?
  entityType     String
  entityId       String
  action         String
  metadata       Json?
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  actor          User?        @relation(fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([organizationId, entityType, entityId])
  @@index([createdAt])
}

model AnalyticsEvent {
  id              String                       @id @default(cuid())
  organizationId  String
  eventName       String
  actorRole       String
  source          String
  entityType      String?
  entityId        String?
  payload         Json?
  idempotencyKey  String?                      @unique
  occurredAt      DateTime
  pilotOrg        Boolean                      @default(false)
  pilotCohortId   String?
  createdAt       DateTime                     @default(now())
  organization    Organization                 @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  conversionLinks PricingConversionEventLink[]

  @@index([organizationId, eventName, occurredAt])
  @@index([pilotOrg, pilotCohortId, occurredAt])
}

model PricingExperiment {
  id                String                  @id @default(cuid())
  key               String                  @unique
  name              String
  description       String?
  status            ExperimentStatus        @default(draft)
  startsAt          DateTime?
  endsAt            DateTime?
  killSwitchEnabled Boolean                 @default(false)
  maxExposure       Int?
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  variants          PricingVariant[]
  allocationRules   PricingAllocationRule[]
  exposureLogs      PricingExposureLog[]

  @@index([status, startsAt, endsAt])
}

model PricingVariant {
  id                String               @id @default(cuid())
  experimentId      String
  key               String
  name              String
  weight            Int                  @default(1)
  pricingMultiplier Float?
  config            Json?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  experiment        PricingExperiment    @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  exposureLogs      PricingExposureLog[]

  @@unique([experimentId, key])
  @@index([experimentId])
}

model PricingAllocationRule {
  id           String               @id @default(cuid())
  experimentId String
  targetType   AllocationTargetType
  targetValue  String?
  createdAt    DateTime             @default(now())
  experiment   PricingExperiment    @relation(fields: [experimentId], references: [id], onDelete: Cascade)

  @@index([experimentId, targetType, targetValue])
}

model PricingExposureLog {
  id              String                       @id @default(cuid())
  experimentId    String
  variantId       String
  organizationId  String
  subjectType     String
  subjectKey      String
  source          String
  entityType      String?
  entityId        String?
  idempotencyKey  String?                      @unique
  occurredAt      DateTime                     @default(now())
  createdAt       DateTime                     @default(now())
  experiment      PricingExperiment            @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  variant         PricingVariant               @relation(fields: [variantId], references: [id], onDelete: Cascade)
  organization    Organization                 @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  conversionLinks PricingConversionEventLink[]

  @@index([experimentId, variantId, occurredAt])
  @@index([organizationId, occurredAt])
  @@index([subjectType, subjectKey, occurredAt])
  @@index([entityType, entityId, occurredAt])
}

model PricingConversionEventLink {
  id               String             @id @default(cuid())
  exposureLogId    String
  analyticsEventId String
  eventName        String
  entityType       String?
  entityId         String?
  occurredAt       DateTime
  createdAt        DateTime           @default(now())
  exposureLog      PricingExposureLog @relation(fields: [exposureLogId], references: [id], onDelete: Cascade)
  analyticsEvent   AnalyticsEvent     @relation(fields: [analyticsEventId], references: [id], onDelete: Cascade)

  @@unique([exposureLogId, analyticsEventId])
  @@index([eventName, occurredAt])
}

model SupportTicket {
  id             String                @id @default(cuid())
  organizationId String
  reporterUserId String?
  title          String
  description    String
  status         SupportTicketStatus   @default(open)
  severity       SupportTicketSeverity @default(p2)
  routePath      String?
  screenName     String?
  appVersion     String?
  correlationId  String?
  requestId      String?
  attachments    Json?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  resolvedAt     DateTime?
  organization   Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  reporter       User?                 @relation(fields: [reporterUserId], references: [id], onDelete: SetNull)
  notes          SupportTicketNote[]
  sla            SupportTicketSla?

  @@index([organizationId, status, severity, createdAt])
  @@index([reporterUserId, createdAt])
}

model SupportTicketNote {
  id           String        @id @default(cuid())
  ticketId     String
  authorUserId String?
  note         String
  createdAt    DateTime      @default(now())
  ticket       SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  author       User?         @relation(fields: [authorUserId], references: [id], onDelete: SetNull)

  @@index([ticketId, createdAt])
}

model SupportTicketSla {
  id                         String         @id @default(cuid())
  ticketId                   String         @unique
  policyVersion              String
  businessHoursOnly          Boolean        @default(false)
  firstResponseTargetMinutes Int
  resolutionTargetMinutes    Int
  clockStartedAt             DateTime
  firstResponseDueAt         DateTime
  resolutionDueAt            DateTime
  firstResponseAt            DateTime?
  resolvedAt                 DateTime?
  firstResponseBreachedAt    DateTime?
  resolutionBreachedAt       DateTime?
  state                      SlaBreachState @default(healthy)
  pausedAt                   DateTime?
  totalPausedSeconds         Int            @default(0)
  lastEvaluatedAt            DateTime       @default(now())
  createdAt                  DateTime       @default(now())
  updatedAt                  DateTime       @updatedAt
  ticket                     SupportTicket  @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([state, lastEvaluatedAt])
  @@index([clockStartedAt, resolutionDueAt])
}
