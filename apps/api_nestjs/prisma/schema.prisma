generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum MembershipRole {
  owner
  manager
  shooter
  editor
  renter
  client
}

enum LeadStatus {
  new
  contacted
  qualified
  converted
  archived
}

enum BookingStatus {
  draft
  confirmed
  cancelled
  completed
}

enum QuoteStatus {
  draft
  sent
  accepted
  rejected
  expired
}

enum ProjectStatus {
  preprod
  shoot
  edit
  review
  delivered
  closed
}

enum ClientApprovalState {
  pending
  approved
  changes_requested
}

enum AssetCondition {
  excellent
  good
  fair
  damaged
}

enum RentalOrderStatus {
  reserved
  picked_up
  returned
  incident
  cancelled
}

enum InvoiceStatus {
  draft
  issued
  partially_paid
  paid
  overdue
  cancelled
}

enum PaymentStatus {
  pending
  succeeded
  failed
  refunded
}

enum BillingPriceComponentType {
  fixed
  seat
  usage
}

enum BillingCycle {
  monthly
  annual
}

enum SubscriptionStatus {
  active
  cancelled
}

enum TrueUpStatus {
  pending
  invoiced
  settled
}

enum BillingAdjustmentStatus {
  pending_approval
  approved
  rejected
}

enum ExperimentStatus {
  draft
  active
  paused
  stopped
}

enum AllocationTargetType {
  all
  organization
  cohort
}

enum SupportTicketStatus {
  open
  triaged
  in_progress
  resolved
  closed
}

enum SupportTicketSeverity {
  p0
  p1
  p2
  p3
}

enum SlaBreachState {
  healthy
  at_risk
  breached
  recovered
}

enum MobileSyncState {
  pending
  synced
  conflict
  manual_review
  failed
}

enum WorkflowStatus {
  draft
  published
  paused
  stopped
}

enum WorkflowVersionStatus {
  draft
  published
  archived
}

enum WorkflowConditionOperator {
  AND
  OR
}

enum WorkflowExecutionStatus {
  success
  skipped
  blocked
  failed
}

enum ReconciliationRunStatus {
  completed
  failed
}

enum ReconciliationItemStatus {
  matched
  discrepant
}

enum ReconciliationDiscrepancyType {
  MissingInternalRecord
  MissingProviderRecord
  AmountMismatch
  CurrencyMismatch
  StatusMismatch
  DuplicateChargeSuspected
}

enum ReconciliationDiscrepancyStatus {
  open
  acknowledged
  resolved
}

enum RiskScoringMode {
  OFF
  ADVISORY
  SOFT_ENFORCE
  HARD_ENFORCE
}

enum RiskLevel {
  low
  medium
  high
}

enum ContractStatus {
  draft
  legal_review
  business_approval
  sent
  signed
  active
  declined
  expired
}

enum ContractSignatureStatus {
  pending
  signed
  declined
  expired
}

enum ContractApprovalFlowStatus {
  pending
  approved
  rejected
}

enum ContractApprovalStepStatus {
  pending
  approved
  rejected
}

enum ModerationPolicyStatus {
  draft
  active
  retired
}

enum ModerationCaseStatus {
  open
  in_review
  resolved
  appealed
  closed
}

enum ModerationActionType {
  allow
  warn
  throttle
  quarantine
  block
  escalate
}

enum ModerationSanctionStatus {
  active
  expired
  revoked
}

enum SettlementPartnerStatus {
  active
  paused
  terminated
}

enum SettlementPeriodStatus {
  draft
  review
  approved
  paid
  reconciled
  on_hold
}

enum SettlementPayoutStatus {
  pending
  on_hold
  paid
  failed
}

enum StrategicMetricKind {
  north_star
  leading_indicator
}

enum StrategicDefinitionStatus {
  active
  archived
}

enum PartnerCredentialStatus {
  active
  suspended
  revoked
}

model User {
  id             String              @id @default(cuid())
  email          String              @unique
  firstName      String
  lastName       String
  passwordHash   String              @default("")
  mfaEnabled     Boolean             @default(false)
  deactivatedAt  DateTime?
  deletedAt      DateTime?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  memberships    Membership[]
  projects       Project[]
  rentalOrders   RentalOrder[]
  payments       Payment[]
  auditLogs      AuditLog[]
  refreshTokens  RefreshToken[]
  rentalEvidence RentalEvidence[]
  supportTickets SupportTicket[]
  supportNotes   SupportTicketNote[]
  reconciliationRunsTriggered      ReconciliationRun[]         @relation("ReconciliationRunTriggeredBy")
  reconciliationDiscrepanciesOwned ReconciliationDiscrepancy[] @relation("ReconciliationOwner")
  reconciliationDiscrepanciesAcked ReconciliationDiscrepancy[] @relation("ReconciliationAcknowledgedBy")
  reconciliationDiscrepanciesResolved ReconciliationDiscrepancy[] @relation("ReconciliationResolvedBy")
  reconciliationActions            ReconciliationActionLog[]
  riskEvaluations                 RiskEvaluation[]
  complianceExportRecords         ComplianceExportRecord[]
  purgeRequestsRequested          EnterprisePurgeRequest[] @relation("EnterprisePurgeRequestRequestedBy")
  purgeRequestsApproved           EnterprisePurgeRequest[] @relation("EnterprisePurgeRequestApprovedBy")
  purgeRequestsTarget             EnterprisePurgeRequest[] @relation("EnterprisePurgeRequestTargetUser")
  rentalSyncDiagnosticsAsLastActor RentalSyncDiagnostic[]
  billingSubscriptions            BillingSubscription[]
  billingUsageRecordsIngested     BillingUsageRecord[] @relation("BillingUsageIngestedBy")
  billingSeatChangeLogs           BillingSubscriptionSeatChangeLog[]
  billingAdjustmentsRequested     BillingAdjustmentRequest[] @relation("BillingAdjustmentRequestedBy")
  billingAdjustmentsApproved      BillingAdjustmentRequest[] @relation("BillingAdjustmentApprovedBy")
  contractApprovalStepsActed      ContractApprovalStep[]
  moderationDecisions             ModerationDecision[]
  moderationAppealsRequested      ModerationAppeal[]
  moderationAbuseReports          ModerationAbuseReport[]
  settlementStatementsApproved    SettlementStatement[]
  strategicMetricVersionsApproved StrategicMetricDefinitionVersion[]
}

model RefreshToken {
  id         String    @id @default(cuid())
  userId     String
  tokenHash  String    @unique
  jti        String    @unique
  expiresAt  DateTime
  revokedAt  DateTime?
  createdAt  DateTime  @default(now())
  replacedBy String?
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
}

model Organization {
  id                   String                @id @default(cuid())
  name                 String
  pilotOrg             Boolean               @default(false)
  pilotCohortId        String?
  ssoEnforced          Boolean               @default(false)
  ssoProvider          String?
  ssoDomains           String[]
  enterpriseScimEnabled Boolean             @default(false)
  sessionDurationMinutes Int                @default(10080)
  mfaEnforced          Boolean               @default(false)
  ipAllowlist          String[]
  retentionDays        Int                   @default(365)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  memberships          Membership[]
  clients              Client[]
  leads                Lead[]
  quotes               Quote[]
  bookings             Booking[]
  projects             Project[]
  assets               Asset[]
  inventoryItems       InventoryItem[]
  rentalOrders         RentalOrder[]
  invoices             Invoice[]
  payments             Payment[]
  paymentWebhookEvents PaymentWebhookEvent[]
  auditLogs            AuditLog[]
  rentalEvidence       RentalEvidence[]
  rentalSyncDiagnostics RentalSyncDiagnostic[]
  workflows             Workflow[]
  workflowExecutionLogs WorkflowExecutionLog[]
  analyticsEvents      AnalyticsEvent[]
  pricingExposureLogs  PricingExposureLog[]
  supportTickets       SupportTicket[]
  reconciliationRuns   ReconciliationRun[]
  reconciliationItems  ReconciliationItem[]
  reconciliationDiscrepancies ReconciliationDiscrepancy[]
  reconciliationActionLogs    ReconciliationActionLog[]
  riskEvaluations             RiskEvaluation[]
  partnerCredentials          PartnerApiCredential[]
  partnerRequestLogs          PartnerApiRequestLog[]
  partnerIdempotencyRecords   PartnerApiIdempotencyRecord[]
  complianceExportRecords      ComplianceExportRecord[]
  purgeRequests               EnterprisePurgeRequest[]
  billingPlans                BillingPlan[]
  billingPlanVersions         BillingPlanVersion[]
  billingSubscriptions        BillingSubscription[]
  billingMeters               BillingMeter[]
  billingUsageRecords         BillingUsageRecord[]
  billingTrueUps              BillingTrueUpRecord[]
  billingInvoiceLines         BillingInvoiceLine[]
  billingSeatChangeLogs       BillingSubscriptionSeatChangeLog[]
  billingAdjustments          BillingAdjustmentRequest[]
  contractClauseSets          ContractClauseSet[]
  contracts                   Contract[]
  moderationPolicies          ModerationPolicy[]
  moderationCases             ModerationCase[]
  moderationSanctions         ModerationSanction[]
  moderationAbuseReports      ModerationAbuseReport[]
  settlementPartners          SettlementPartner[]
  settlementAgreements        SettlementAgreement[]
  settlementPeriods           SettlementPeriod[]
  settlementAccrualEntries    SettlementAccrualEntry[]
  settlementAdjustmentEntries SettlementAdjustmentEntry[]
  settlementStatements        SettlementStatement[]
  settlementPayouts           SettlementPayoutInstruction[]
  strategicMetricDefinitions  StrategicMetricDefinition[]
  strategicScorecards         StrategicScorecard[]
}

model Membership {
  id             String         @id @default(cuid())
  organizationId String
  userId         String
  role           MembershipRole
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([userId])
}

model Client {
  id             String        @id @default(cuid())
  organizationId String
  name           String
  email          String?
  phone          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  bookings       Booking[]
  quotes         Quote[]
  projects       Project[]
  invoices       Invoice[]
  rentalOrders   RentalOrder[]
  contracts      Contract[]
  billingSubscriptions BillingSubscription[]

  @@index([organizationId])
}

model Lead {
  id             String       @id @default(cuid())
  organizationId String
  name           String
  email          String?
  phone          String?
  source         String?
  status         LeadStatus   @default(new)
  convertedAt    DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, status])
}

model Booking {
  id             String        @id @default(cuid())
  organizationId String
  clientId       String
  quoteId        String?       @unique
  title          String
  startsAt       DateTime
  endsAt         DateTime
  status         BookingStatus @default(draft)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client         Client        @relation(fields: [clientId], references: [id], onDelete: Restrict)
  quote          Quote?        @relation(fields: [quoteId], references: [id], onDelete: SetNull)
  projects       Project[]

  @@index([organizationId, startsAt, endsAt])
}

model Quote {
  id             String          @id @default(cuid())
  organizationId String
  clientId       String
  title          String
  status         QuoteStatus     @default(draft)
  startsAt       DateTime
  endsAt         DateTime
  subtotalCents  Int
  taxCents       Int             @default(0)
  totalCents     Int
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client         Client          @relation(fields: [clientId], references: [id], onDelete: Restrict)
  booking        Booking?
  lineItems      QuoteLineItem[]

  @@index([organizationId, status])
}

model QuoteLineItem {
  id             String   @id @default(cuid())
  quoteId        String
  description    String
  quantity       Int
  unitPriceCents Int
  lineTotalCents Int
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  quote          Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
}

model Project {
  id                  String              @id @default(cuid())
  organizationId      String
  bookingId           String?
  clientId            String
  ownerUserId         String?
  name                String
  status              ProjectStatus       @default(preprod)
  clientApprovalState ClientApprovalState @default(pending)
  revisionCount       Int                 @default(0)
  lastRevisionComment String?
  clientApprovedAt    DateTime?
  dueAt               DateTime?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  organization        Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  booking             Booking?            @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  client              Client              @relation(fields: [clientId], references: [id], onDelete: Restrict)
  owner               User?               @relation(fields: [ownerUserId], references: [id], onDelete: SetNull)

  @@index([organizationId, status])
}

model Asset {
  id             String          @id @default(cuid())
  organizationId String
  name           String
  category       String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  inventoryItems InventoryItem[]

  @@index([organizationId, category])
}

model InventoryItem {
  id             String         @id @default(cuid())
  organizationId String
  assetId        String
  serialNumber   String
  condition      AssetCondition @default(good)
  ownerName      String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  asset          Asset          @relation(fields: [assetId], references: [id], onDelete: Restrict)
  rentalOrders   RentalOrder[]

  @@unique([organizationId, serialNumber])
  @@index([organizationId, condition])
}

model RentalOrder {
  id              String            @id @default(cuid())
  organizationId  String
  inventoryItemId String
  clientId        String?
  assignedUserId  String?
  startsAt        DateTime
  endsAt          DateTime
  status          RentalOrderStatus @default(reserved)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  organization    Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  inventoryItem   InventoryItem     @relation(fields: [inventoryItemId], references: [id], onDelete: Restrict)
  client          Client?           @relation(fields: [clientId], references: [id], onDelete: SetNull)
  assignedUser    User?             @relation(fields: [assignedUserId], references: [id], onDelete: SetNull)
  evidence        RentalEvidence[]
  syncDiagnostics RentalSyncDiagnostic[]

  @@index([organizationId, status])
}

model RentalSyncDiagnostic {
  id                String          @id @default(cuid())
  organizationId    String
  rentalOrderId     String
  deviceSessionId   String
  operationId       String          @unique
  operationType     String
  syncState         MobileSyncState @default(pending)
  payloadHash       String
  baseVersion       String?
  serverVersion     String?
  conflictingFields String[]
  lastActorUserId   String?
  lastUpdatedAt     DateTime?
  retryCount        Int             @default(0)
  lastError         String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  organization      Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  rentalOrder       RentalOrder     @relation(fields: [rentalOrderId], references: [id], onDelete: Cascade)
  lastActor         User?           @relation(fields: [lastActorUserId], references: [id], onDelete: SetNull)

  @@index([organizationId, deviceSessionId, updatedAt])
  @@index([organizationId, syncState, updatedAt])
}

model Workflow {
  id                    String                 @id @default(cuid())
  organizationId        String
  name                  String
  description           String?
  status                WorkflowStatus         @default(draft)
  killSwitchEnabled     Boolean                @default(false)
  dryRunEnabled         Boolean                @default(false)
  maxExecutionsPerHour  Int                    @default(100)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  organization          Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  versions              WorkflowVersion[]
  triggers              WorkflowTrigger[]
  conditionGroups       WorkflowConditionGroup[]
  actions               WorkflowAction[]
  executionLogs         WorkflowExecutionLog[]

  @@index([organizationId, status])
}

model WorkflowVersion {
  id                 String                @id @default(cuid())
  workflowId         String
  versionNumber      Int
  status             WorkflowVersionStatus @default(draft)
  triggerConfig      Json
  conditionConfig    Json
  actionConfig       Json
  activationStartsAt DateTime?
  activationEndsAt   DateTime?
  createdAt          DateTime              @default(now())
  workflow           Workflow              @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  conditionGroups    WorkflowConditionGroup[]
  actions            WorkflowAction[]
  executionLogs      WorkflowExecutionLog[]

  @@unique([workflowId, versionNumber])
  @@index([workflowId, status, createdAt])
}

model WorkflowTrigger {
  id            String   @id @default(cuid())
  workflowId    String
  eventType     String
  source        String   @default("api")
  isEnabled     Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  workflow      Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId, eventType, isEnabled])
}

model WorkflowConditionGroup {
  id             String                    @id @default(cuid())
  workflowId     String
  workflowVersionId String
  parentGroupId  String?
  operator       WorkflowConditionOperator @default(AND)
  definition     Json
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @updatedAt
  workflow       Workflow                  @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  workflowVersion WorkflowVersion          @relation(fields: [workflowVersionId], references: [id], onDelete: Cascade)

  @@index([workflowId, workflowVersionId, parentGroupId])
}

model WorkflowAction {
  id               String   @id @default(cuid())
  workflowId       String
  workflowVersionId String
  actionType       String
  orderIndex       Int      @default(0)
  config           Json
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  workflow         Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  workflowVersion  WorkflowVersion @relation(fields: [workflowVersionId], references: [id], onDelete: Cascade)

  @@index([workflowId, workflowVersionId, orderIndex])
}

model WorkflowExecutionLog {
  id                String                  @id @default(cuid())
  organizationId    String
  workflowId        String
  workflowVersionId String
  triggerEvent      String
  entityType        String
  entityId          String
  dryRun            Boolean                 @default(false)
  status            WorkflowExecutionStatus @default(success)
  triggerInput      Json
  rulePath          Json
  actionResults     Json
  errorMessage      String?
  createdAt         DateTime                @default(now())
  organization      Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  workflow          Workflow                @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  workflowVersion   WorkflowVersion         @relation(fields: [workflowVersionId], references: [id], onDelete: Cascade)

  @@index([organizationId, workflowId, entityType, entityId, createdAt])
  @@index([workflowId, status, createdAt])
}

model RentalEvidence {
  id             String       @id @default(cuid())
  organizationId String
  rentalOrderId  String
  actorUserId    String?
  photoUrl       String
  note           String
  occurredAt     DateTime
  latitude       Float?
  longitude      Float?
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  rentalOrder    RentalOrder  @relation(fields: [rentalOrderId], references: [id], onDelete: Cascade)
  actor          User?        @relation(fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([organizationId, rentalOrderId, occurredAt])
}

model Invoice {
  id             String                @id @default(cuid())
  organizationId String
  clientId       String
  invoiceNumber  String
  status         InvoiceStatus         @default(draft)
  subtotalCents  Int
  taxCents       Int
  totalCents     Int
  issuedAt       DateTime?
  dueAt          DateTime?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  organization   Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client         Client                @relation(fields: [clientId], references: [id], onDelete: Restrict)
  payments       Payment[]
  webhookEvents  PaymentWebhookEvent[]
  reconciliationItems        ReconciliationItem[]
  reconciliationDiscrepancies ReconciliationDiscrepancy[]
  billingLines               BillingInvoiceLine[]
  generatedTrueUps           BillingTrueUpRecord[]
  billingAdjustments         BillingAdjustmentRequest[]

  @@unique([organizationId, invoiceNumber])
  @@index([organizationId, status])
}

model BillingPlan {
  id             String           @id @default(cuid())
  organizationId String
  code           String
  name           String
  description    String?
  billingCycle   BillingCycle
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  versions       BillingPlanVersion[]
  subscriptions  BillingSubscription[]

  @@unique([organizationId, code])
  @@index([organizationId, createdAt])
}

model BillingPlanVersion {
  id                   String                @id @default(cuid())
  organizationId       String
  planId               String
  versionNumber        Int
  currency             String                @default("USD")
  minimumCommitCents   Int                  @default(0)
  effectiveFrom        DateTime
  effectiveTo          DateTime?
  createdAt            DateTime              @default(now())
  organization         Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  plan                 BillingPlan           @relation(fields: [planId], references: [id], onDelete: Cascade)
  components           BillingPriceComponent[]
  subscriptions        BillingSubscription[]

  @@unique([planId, versionNumber])
  @@index([organizationId, planId, effectiveFrom])
}

model BillingPriceComponent {
  id                  String                    @id @default(cuid())
  planVersionId       String
  componentType       BillingPriceComponentType
  code                String
  displayName         String
  unit                String?
  unitPriceCents      Int
  includedUnits       Int                       @default(0)
  minimumUnits        Int                       @default(0)
  tierJson            Json?
  createdAt           DateTime                  @default(now())
  planVersion         BillingPlanVersion        @relation(fields: [planVersionId], references: [id], onDelete: Cascade)
  subscriptionItems   BillingSubscriptionItem[]
  invoiceLines        BillingInvoiceLine[]

  @@unique([planVersionId, code])
  @@index([planVersionId, componentType])
}

model BillingSubscription {
  id                   String                          @id @default(cuid())
  organizationId       String
  clientId             String?
  planId               String
  planVersionId        String
  status               SubscriptionStatus             @default(active)
  currency             String                         @default("USD")
  startsAt             DateTime
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelledAt          DateTime?
  createdByUserId      String?
  createdAt            DateTime                       @default(now())
  updatedAt            DateTime                       @updatedAt
  organization         Organization                   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client               Client?                        @relation(fields: [clientId], references: [id], onDelete: SetNull)
  plan                 BillingPlan                    @relation(fields: [planId], references: [id], onDelete: Restrict)
  planVersion          BillingPlanVersion             @relation(fields: [planVersionId], references: [id], onDelete: Restrict)
  createdBy            User?                          @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)
  items                BillingSubscriptionItem[]
  usageRecords         BillingUsageRecord[]
  trueUps              BillingTrueUpRecord[]
  seatChangeLogs       BillingSubscriptionSeatChangeLog[]
  invoiceLines         BillingInvoiceLine[]
  adjustments          BillingAdjustmentRequest[]

  @@index([organizationId, status, currentPeriodEnd])
}

model BillingSubscriptionItem {
  id               String              @id @default(cuid())
  subscriptionId   String
  componentId      String
  quantity         Int                 @default(0)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  subscription     BillingSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  component        BillingPriceComponent @relation(fields: [componentId], references: [id], onDelete: Restrict)

  @@unique([subscriptionId, componentId])
  @@index([subscriptionId, createdAt])
}

model BillingMeter {
  id              String              @id @default(cuid())
  organizationId  String
  code            String
  unit            String
  description     String?
  createdAt       DateTime            @default(now())
  organization    Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  usageRecords    BillingUsageRecord[]

  @@unique([organizationId, code])
}

model BillingUsageRecord {
  id               String              @id @default(cuid())
  organizationId   String
  subscriptionId   String
  meterId          String
  quantity         Int
  usageAt          DateTime
  dedupKey         String
  source           String              @default("api")
  correctionOfId   String?
  ingestedByUserId String?
  ingestedAt       DateTime            @default(now())
  organization     Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  subscription     BillingSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  meter            BillingMeter        @relation(fields: [meterId], references: [id], onDelete: Restrict)
  correctionOf     BillingUsageRecord? @relation("BillingUsageCorrection", fields: [correctionOfId], references: [id], onDelete: SetNull)
  corrections      BillingUsageRecord[] @relation("BillingUsageCorrection")
  ingestedBy       User?               @relation("BillingUsageIngestedBy", fields: [ingestedByUserId], references: [id], onDelete: SetNull)

  @@unique([organizationId, dedupKey])
  @@index([subscriptionId, usageAt])
}

model BillingTrueUpRecord {
  id               String              @id @default(cuid())
  organizationId   String
  subscriptionId   String
  periodStart      DateTime
  periodEnd        DateTime
  amountCents      Int
  status           TrueUpStatus        @default(pending)
  generatedInvoiceId String?
  metadata         Json?
  createdAt        DateTime            @default(now())
  organization     Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  subscription     BillingSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  generatedInvoice Invoice?            @relation(fields: [generatedInvoiceId], references: [id], onDelete: SetNull)

  @@index([organizationId, status, createdAt])
}

model BillingInvoiceLine {
  id               String               @id @default(cuid())
  organizationId   String
  invoiceId        String
  subscriptionId   String?
  componentId      String?
  lineType         String
  description      String
  quantity         Int
  unitPriceCents   Int
  amountCents      Int
  periodStart      DateTime?
  periodEnd        DateTime?
  createdAt        DateTime             @default(now())
  organization     Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoice          Invoice              @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  subscription     BillingSubscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  component        BillingPriceComponent? @relation(fields: [componentId], references: [id], onDelete: SetNull)

  @@index([invoiceId, createdAt])
  @@index([organizationId, subscriptionId])
}

model BillingSubscriptionSeatChangeLog {
  id               String              @id @default(cuid())
  organizationId   String
  subscriptionId   String
  fromQuantity     Int
  toQuantity       Int
  prorationDeltaCents Int
  changedAt        DateTime            @default(now())
  changedByUserId  String?
  organization     Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  subscription     BillingSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  changedBy        User?               @relation(fields: [changedByUserId], references: [id], onDelete: SetNull)

  @@index([subscriptionId, changedAt])
}

model BillingAdjustmentRequest {
  id               String                  @id @default(cuid())
  organizationId   String
  subscriptionId   String?
  invoiceId        String?
  amountCents      Int
  reason           String
  status           BillingAdjustmentStatus @default(pending_approval)
  requestedByUserId String?
  approvedByUserId String?
  approvedAt       DateTime?
  metadata         Json?
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt
  organization     Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  subscription     BillingSubscription?    @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  invoice          Invoice?                @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  requestedBy      User?                   @relation("BillingAdjustmentRequestedBy", fields: [requestedByUserId], references: [id], onDelete: SetNull)
  approvedBy       User?                   @relation("BillingAdjustmentApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)

  @@index([organizationId, status, createdAt])
}

model Payment {
  id             String                @id @default(cuid())
  organizationId String
  invoiceId      String
  userId         String?
  provider       String
  providerRef    String?
  amountCents    Int
  currency       String                @default("USD")
  status         PaymentStatus         @default(pending)
  paidAt         DateTime?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  organization   Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoice        Invoice               @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  user           User?                 @relation(fields: [userId], references: [id], onDelete: SetNull)
  webhookEvents  PaymentWebhookEvent[]
  reconciliationItems        ReconciliationItem[]
  reconciliationDiscrepancies ReconciliationDiscrepancy[]

  @@index([organizationId, status])
}

model PaymentWebhookEvent {
  id             String       @id @default(cuid())
  provider       String
  eventId        String
  organizationId String
  invoiceId      String
  paymentId      String?
  payload        Json
  processedAt    DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoice        Invoice      @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  payment        Payment?     @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  reconciliationItems ReconciliationItem[]
  reconciliationDiscrepancies ReconciliationDiscrepancy[]

  @@unique([provider, eventId])
  @@index([organizationId, invoiceId, processedAt])
}

model ReconciliationRun {
  id                   String                 @id @default(cuid())
  organizationId       String
  periodStart          DateTime
  periodEnd            DateTime
  status               ReconciliationRunStatus @default(completed)
  totalInternalRecords Int                    @default(0)
  totalProviderRecords Int                    @default(0)
  matchedCount         Int                    @default(0)
  discrepancyCount     Int                    @default(0)
  mismatchAmountCents  Int                    @default(0)
  reportJson           Json?
  reportMarkdown       String?
  triggeredByUserId    String?
  createdAt            DateTime               @default(now())
  completedAt          DateTime?
  organization         Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  triggeredBy          User?                  @relation("ReconciliationRunTriggeredBy", fields: [triggeredByUserId], references: [id], onDelete: SetNull)
  items                ReconciliationItem[]
  discrepancies        ReconciliationDiscrepancy[]
  actionLogs           ReconciliationActionLog[]

  @@index([organizationId, createdAt])
}

model ReconciliationItem {
  id                 String                     @id @default(cuid())
  runId              String
  organizationId     String
  invoiceId          String?
  paymentId          String?
  providerEventId    String?
  providerRef        String?
  internalAmountCents Int?
  providerAmountCents Int?
  currency           String?
  status             ReconciliationItemStatus   @default(matched)
  discrepancyType    ReconciliationDiscrepancyType?
  createdAt          DateTime                   @default(now())
  run                ReconciliationRun          @relation(fields: [runId], references: [id], onDelete: Cascade)
  organization       Organization               @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoice            Invoice?                   @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  payment            Payment?                   @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  providerEvent      PaymentWebhookEvent?       @relation(fields: [providerEventId], references: [id], onDelete: SetNull)
  discrepancy        ReconciliationDiscrepancy?

  @@index([runId, status])
  @@index([organizationId, invoiceId])
}

model ReconciliationDiscrepancy {
  id                 String                         @id @default(cuid())
  runId              String
  itemId             String?                        @unique
  organizationId     String
  invoiceId          String?
  paymentId          String?
  providerEventId    String?
  type               ReconciliationDiscrepancyType
  status             ReconciliationDiscrepancyStatus @default(open)
  ownerUserId        String?
  acknowledgedByUserId String?
  acknowledgedAt     DateTime?
  resolvedByUserId   String?
  resolvedAt         DateTime?
  resolutionReason   String?
  notes              String?
  amountDeltaCents   Int?
  createdAt          DateTime                       @default(now())
  updatedAt          DateTime                       @updatedAt
  run                ReconciliationRun              @relation(fields: [runId], references: [id], onDelete: Cascade)
  item               ReconciliationItem?            @relation(fields: [itemId], references: [id], onDelete: SetNull)
  organization       Organization                   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoice            Invoice?                       @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  payment            Payment?                       @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  providerEvent      PaymentWebhookEvent?          @relation(fields: [providerEventId], references: [id], onDelete: SetNull)
  owner              User?                          @relation("ReconciliationOwner", fields: [ownerUserId], references: [id], onDelete: SetNull)
  acknowledgedBy     User?                          @relation("ReconciliationAcknowledgedBy", fields: [acknowledgedByUserId], references: [id], onDelete: SetNull)
  resolvedBy         User?                          @relation("ReconciliationResolvedBy", fields: [resolvedByUserId], references: [id], onDelete: SetNull)
  actionLogs         ReconciliationActionLog[]

  @@index([runId, status, type])
  @@index([organizationId, createdAt])
}

model ReconciliationActionLog {
  id              String            @id @default(cuid())
  runId           String
  discrepancyId   String?
  organizationId  String
  actorUserId     String?
  action          String
  note            String?
  metadata        Json?
  createdAt       DateTime          @default(now())
  run             ReconciliationRun @relation(fields: [runId], references: [id], onDelete: Cascade)
  discrepancy     ReconciliationDiscrepancy? @relation(fields: [discrepancyId], references: [id], onDelete: SetNull)
  organization    Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  actor           User?             @relation(fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([runId, createdAt])
  @@index([organizationId, createdAt])
}

model RiskEvaluation {
  id               String          @id @default(cuid())
  organizationId   String
  userId           String?
  flowType         String
  entityType       String?
  entityId         String?
  mode             RiskScoringMode
  riskScore        Int
  riskLevel        RiskLevel
  reasonCodes      String[]
  actionTaken      String
  blocked          Boolean         @default(false)
  bypassed         Boolean         @default(false)
  pilotCohortId    String?
  reviewStatus     String          @default("pending")
  reviewNote       String?
  createdAt        DateTime        @default(now())
  organization     Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user             User?           @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([organizationId, createdAt])
  @@index([flowType, riskLevel, createdAt])
  @@index([reviewStatus, createdAt])
}

model PartnerApiCredential {
  id                    String                  @id @default(cuid())
  organizationId        String
  name                  String
  keyId                 String                  @unique
  keyHash               String
  scopes                String[]
  status                PartnerCredentialStatus @default(active)
  requestsPerMinute     Int                     @default(120)
  dailyQuota            Int                     @default(10000)
  requestSigningRequired Boolean                @default(false)
  signingSecret         String?
  rotatedFromId         String?
  lastUsedAt            DateTime?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  organization          Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  requestLogs           PartnerApiRequestLog[]
  idempotencyRecords    PartnerApiIdempotencyRecord[]

  @@index([organizationId, status])
}

model PartnerApiRequestLog {
  id            String               @id @default(cuid())
  organizationId String
  credentialId  String
  method        String
  path          String
  statusCode    Int
  latencyMs     Int
  createdAt     DateTime             @default(now())
  organization  Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  credential    PartnerApiCredential @relation(fields: [credentialId], references: [id], onDelete: Cascade)

  @@index([credentialId, createdAt])
  @@index([organizationId, createdAt])
}

model PartnerApiIdempotencyRecord {
  id             String               @id @default(cuid())
  organizationId String
  credentialId   String
  method         String
  path           String
  idempotencyKey String
  requestHash    String
  statusCode     Int
  responseBody   Json
  createdAt      DateTime             @default(now())
  organization   Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  credential     PartnerApiCredential @relation(fields: [credentialId], references: [id], onDelete: Cascade)

  @@unique([credentialId, method, path, idempotencyKey])
  @@index([organizationId, createdAt])
}

model ComplianceExportRecord {
  id             String       @id @default(cuid())
  organizationId String
  actorUserId    String?
  exportType     String
  dateFrom       DateTime?
  dateTo         DateTime?
  rowCount       Int          @default(0)
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  actor          User?        @relation(fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([organizationId, exportType, createdAt])
}

model EnterprisePurgeRequest {
  id               String       @id @default(cuid())
  organizationId   String
  targetUserId     String
  requestedByUserId String
  approvedByUserId String?
  status           String       @default("pending")
  reason           String
  approvalReason   String?
  requestedAt      DateTime     @default(now())
  approvedAt       DateTime?
  executedAt       DateTime?
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  targetUser       User         @relation("EnterprisePurgeRequestTargetUser", fields: [targetUserId], references: [id], onDelete: Cascade)
  requestedBy      User         @relation("EnterprisePurgeRequestRequestedBy", fields: [requestedByUserId], references: [id], onDelete: Cascade)
  approvedBy       User?        @relation("EnterprisePurgeRequestApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)

  @@index([organizationId, status, requestedAt])
}

model AuditLog {
  id             String       @id @default(cuid())
  organizationId String
  actorUserId    String?
  entityType     String
  entityId       String
  action         String
  metadata       Json?
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  actor          User?        @relation(fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([organizationId, entityType, entityId])
  @@index([createdAt])
}

model AnalyticsEvent {
  id              String                       @id @default(cuid())
  organizationId  String
  eventName       String
  actorRole       String
  source          String
  entityType      String?
  entityId        String?
  payload         Json?
  idempotencyKey  String?                      @unique
  occurredAt      DateTime
  pilotOrg        Boolean                      @default(false)
  pilotCohortId   String?
  createdAt       DateTime                     @default(now())
  organization    Organization                 @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  conversionLinks PricingConversionEventLink[]

  @@index([organizationId, eventName, occurredAt])
  @@index([pilotOrg, pilotCohortId, occurredAt])
}

model PricingExperiment {
  id                String                  @id @default(cuid())
  key               String                  @unique
  name              String
  description       String?
  status            ExperimentStatus        @default(draft)
  startsAt          DateTime?
  endsAt            DateTime?
  killSwitchEnabled Boolean                 @default(false)
  maxExposure       Int?
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  variants          PricingVariant[]
  allocationRules   PricingAllocationRule[]
  exposureLogs      PricingExposureLog[]

  @@index([status, startsAt, endsAt])
}

model PricingVariant {
  id                String               @id @default(cuid())
  experimentId      String
  key               String
  name              String
  weight            Int                  @default(1)
  pricingMultiplier Float?
  config            Json?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  experiment        PricingExperiment    @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  exposureLogs      PricingExposureLog[]

  @@unique([experimentId, key])
  @@index([experimentId])
}

model PricingAllocationRule {
  id           String               @id @default(cuid())
  experimentId String
  targetType   AllocationTargetType
  targetValue  String?
  createdAt    DateTime             @default(now())
  experiment   PricingExperiment    @relation(fields: [experimentId], references: [id], onDelete: Cascade)

  @@index([experimentId, targetType, targetValue])
}

model PricingExposureLog {
  id              String                       @id @default(cuid())
  experimentId    String
  variantId       String
  organizationId  String
  subjectType     String
  subjectKey      String
  source          String
  entityType      String?
  entityId        String?
  idempotencyKey  String?                      @unique
  occurredAt      DateTime                     @default(now())
  createdAt       DateTime                     @default(now())
  experiment      PricingExperiment            @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  variant         PricingVariant               @relation(fields: [variantId], references: [id], onDelete: Cascade)
  organization    Organization                 @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  conversionLinks PricingConversionEventLink[]

  @@index([experimentId, variantId, occurredAt])
  @@index([organizationId, occurredAt])
  @@index([subjectType, subjectKey, occurredAt])
  @@index([entityType, entityId, occurredAt])
}

model PricingConversionEventLink {
  id               String             @id @default(cuid())
  exposureLogId    String
  analyticsEventId String
  eventName        String
  entityType       String?
  entityId         String?
  occurredAt       DateTime
  createdAt        DateTime           @default(now())
  exposureLog      PricingExposureLog @relation(fields: [exposureLogId], references: [id], onDelete: Cascade)
  analyticsEvent   AnalyticsEvent     @relation(fields: [analyticsEventId], references: [id], onDelete: Cascade)

  @@unique([exposureLogId, analyticsEventId])
  @@index([eventName, occurredAt])
}

model SupportTicket {
  id             String                @id @default(cuid())
  organizationId String
  reporterUserId String?
  title          String
  description    String
  status         SupportTicketStatus   @default(open)
  severity       SupportTicketSeverity @default(p2)
  routePath      String?
  screenName     String?
  appVersion     String?
  correlationId  String?
  requestId      String?
  attachments    Json?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  resolvedAt     DateTime?
  organization   Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  reporter       User?                 @relation(fields: [reporterUserId], references: [id], onDelete: SetNull)
  notes          SupportTicketNote[]
  sla            SupportTicketSla?

  @@index([organizationId, status, severity, createdAt])
  @@index([reporterUserId, createdAt])
}

model SupportTicketNote {
  id           String        @id @default(cuid())
  ticketId     String
  authorUserId String?
  note         String
  createdAt    DateTime      @default(now())
  ticket       SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  author       User?         @relation(fields: [authorUserId], references: [id], onDelete: SetNull)

  @@index([ticketId, createdAt])
}

model SupportTicketSla {
  id                         String         @id @default(cuid())
  ticketId                   String         @unique
  policyVersion              String
  businessHoursOnly          Boolean        @default(false)
  firstResponseTargetMinutes Int
  resolutionTargetMinutes    Int
  clockStartedAt             DateTime
  firstResponseDueAt         DateTime
  resolutionDueAt            DateTime
  firstResponseAt            DateTime?
  resolvedAt                 DateTime?
  firstResponseBreachedAt    DateTime?
  resolutionBreachedAt       DateTime?
  state                      SlaBreachState @default(healthy)
  pausedAt                   DateTime?
  totalPausedSeconds         Int            @default(0)
  lastEvaluatedAt            DateTime       @default(now())
  createdAt                  DateTime       @default(now())
  updatedAt                  DateTime       @updatedAt
  ticket                     SupportTicket  @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([state, lastEvaluatedAt])
  @@index([clockStartedAt, resolutionDueAt])
}

model ContractClauseSet {
  id                 String            @id @default(cuid())
  organizationId     String
  name               String
  clauses            Json
  requiredClauseKeys String[]
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  organization       Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  versions           ContractVersion[]

  @@unique([organizationId, name])
  @@index([organizationId, createdAt])
}

model Contract {
  id                   String                  @id @default(cuid())
  organizationId       String
  clientId             String?
  contractType         String
  title                String
  status               ContractStatus          @default(draft)
  signatureStatus      ContractSignatureStatus @default(pending)
  contractValueCents   Int
  riskTier             String                  @default("standard")
  currentVersionId     String?
  approvalFlowId       String?                 @unique
  signatureProviderRef String?
  signatureLastEventId String?
  signatureLastEventAt DateTime?
  sentAt               DateTime?
  signedAt             DateTime?
  activeAt             DateTime?
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt
  organization         Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client               Client?                 @relation(fields: [clientId], references: [id], onDelete: SetNull)
  currentVersion       ContractVersion?        @relation("ContractCurrentVersion", fields: [currentVersionId], references: [id], onDelete: SetNull)
  versions             ContractVersion[]       @relation("ContractVersions")
  amendments           ContractAmendment[]
  approvalFlow         ContractApprovalFlow?
  renewalSchedule      ContractRenewalSchedule?

  @@index([organizationId, status, createdAt])
  @@index([organizationId, contractType, createdAt])
}

model ContractVersion {
  id                      String              @id @default(cuid())
  contractId              String
  versionNumber           Int
  clauseSetId             String?
  clauseKeys              String[]
  missingMandatoryClauses String[]
  snapshot                Json
  createdAt               DateTime            @default(now())
  contract                Contract            @relation("ContractVersions", fields: [contractId], references: [id], onDelete: Cascade)
  clauseSet               ContractClauseSet?  @relation(fields: [clauseSetId], references: [id], onDelete: SetNull)
  currentForContract      Contract[]          @relation("ContractCurrentVersion")
  fromAmendments          ContractAmendment[] @relation("ContractAmendmentFromVersion")
  toAmendments            ContractAmendment[] @relation("ContractAmendmentToVersion")

  @@unique([contractId, versionNumber])
  @@index([contractId, createdAt])
}

model ContractAmendment {
  id            String          @id @default(cuid())
  contractId    String
  fromVersionId String
  toVersionId   String
  reason        String
  status        ContractStatus  @default(draft)
  createdAt     DateTime        @default(now())
  contract      Contract        @relation(fields: [contractId], references: [id], onDelete: Cascade)
  fromVersion   ContractVersion @relation("ContractAmendmentFromVersion", fields: [fromVersionId], references: [id], onDelete: Restrict)
  toVersion     ContractVersion @relation("ContractAmendmentToVersion", fields: [toVersionId], references: [id], onDelete: Restrict)

  @@index([contractId, createdAt])
}

model ContractRenewalSchedule {
  id                 String    @id @default(cuid())
  contractId         String    @unique
  renewAt            DateTime
  reminderDaysBefore Int       @default(30)
  autoDraftAmendment Boolean   @default(true)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  contract           Contract  @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([renewAt])
}

model ContractApprovalFlow {
  id             String                     @id @default(cuid())
  contractId     String                     @unique
  status         ContractApprovalFlowStatus @default(pending)
  policySnapshot Json
  createdAt      DateTime                   @default(now())
  updatedAt      DateTime                   @updatedAt
  contract       Contract                   @relation(fields: [contractId], references: [id], onDelete: Cascade)
  steps          ContractApprovalStep[]

  @@index([status, createdAt])
}

model ContractApprovalStep {
  id             String                     @id @default(cuid())
  approvalFlowId String
  stepOrder      Int
  approverRole   String
  status         ContractApprovalStepStatus @default(pending)
  actedByUserId  String?
  actedAt        DateTime?
  note           String?
  createdAt      DateTime                   @default(now())
  updatedAt      DateTime                   @updatedAt
  approvalFlow   ContractApprovalFlow       @relation(fields: [approvalFlowId], references: [id], onDelete: Cascade)
  actedBy        User?                      @relation(fields: [actedByUserId], references: [id], onDelete: SetNull)

  @@unique([approvalFlowId, stepOrder])
  @@index([status, createdAt])
}

model ModerationPolicy {
  id             String                 @id @default(cuid())
  organizationId String
  name           String
  description    String?
  status         ModerationPolicyStatus @default(draft)
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  organization   Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  versions       ModerationPolicyVersion[]
  cases          ModerationCase[]

  @@index([organizationId, status, createdAt])
}

model ModerationPolicyVersion {
  id               String           @id @default(cuid())
  policyId         String
  versionNumber    Int
  violationTypes   String[]
  keywordRules     String[]
  classifierConfig Json?
  createdAt        DateTime         @default(now())
  policy           ModerationPolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)
  cases            ModerationCase[]

  @@unique([policyId, versionNumber])
  @@index([policyId, createdAt])
}

model ModerationCase {
  id               String               @id @default(cuid())
  organizationId   String
  policyId         String?
  policyVersionId  String?
  entityType       String
  entityId         String
  source           String
  violationType    String
  severity         String
  status           ModerationCaseStatus @default(open)
  contentSnapshot  String
  matchedRules     String[]
  riskScore        Int                  @default(0)
  suggestedAction  ModerationActionType @default(allow)
  createdAt        DateTime             @default(now())
  resolvedAt       DateTime?
  organization     Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  policy           ModerationPolicy?    @relation(fields: [policyId], references: [id], onDelete: SetNull)
  policyVersion    ModerationPolicyVersion? @relation(fields: [policyVersionId], references: [id], onDelete: SetNull)
  decisions        ModerationDecision[]
  appeals          ModerationAppeal[]
  sanctions        ModerationSanction[]

  @@index([organizationId, status, createdAt])
  @@index([organizationId, violationType, createdAt])
}

model ModerationDecision {
  id               String               @id @default(cuid())
  moderationCaseId String
  action           ModerationActionType
  reasonCode       String
  note             String?
  actorUserId      String?
  createdAt        DateTime             @default(now())
  moderationCase   ModerationCase       @relation(fields: [moderationCaseId], references: [id], onDelete: Cascade)
  actor            User?                @relation(fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([moderationCaseId, createdAt])
}

model ModerationAppeal {
  id               String               @id @default(cuid())
  moderationCaseId String
  reason           String
  status           ModerationCaseStatus @default(open)
  requestedByUserId String?
  createdAt        DateTime             @default(now())
  moderationCase   ModerationCase       @relation(fields: [moderationCaseId], references: [id], onDelete: Cascade)
  requestedBy      User?                @relation(fields: [requestedByUserId], references: [id], onDelete: SetNull)

  @@index([moderationCaseId, createdAt])
}

model ModerationSanction {
  id               String                 @id @default(cuid())
  organizationId   String
  moderationCaseId String
  entityType       String
  entityId         String
  action           ModerationActionType
  status           ModerationSanctionStatus @default(active)
  startsAt         DateTime
  expiresAt        DateTime
  createdAt        DateTime               @default(now())
  organization     Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  moderationCase   ModerationCase         @relation(fields: [moderationCaseId], references: [id], onDelete: Cascade)

  @@index([organizationId, status, expiresAt])
}

model ModerationAbuseReport {
  id             String       @id @default(cuid())
  organizationId String
  entityType     String
  entityId       String
  message        String
  attachmentType String?
  attachmentUrl  String?
  quarantineStatus String
  reporterUserId String?
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  reporter       User?        @relation(fields: [reporterUserId], references: [id], onDelete: SetNull)

  @@index([organizationId, createdAt])
  @@index([entityType, entityId, createdAt])
}

model SettlementPartner {
  id             String                @id @default(cuid())
  organizationId String
  name           String
  externalRef    String?
  status         SettlementPartnerStatus @default(active)
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  organization   Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  agreements     SettlementAgreement[]

  @@unique([organizationId, name])
  @@index([organizationId, status, createdAt])
}

model SettlementAgreement {
  id                   String                @id @default(cuid())
  organizationId       String
  partnerId            String
  status               SettlementPartnerStatus @default(active)
  startsAt             DateTime
  endsAt               DateTime?
  currency             String                @default("USD")
  minimumGuaranteeCents Int                 @default(0)
  clawbackEnabled      Boolean               @default(false)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  organization         Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  partner              SettlementPartner     @relation(fields: [partnerId], references: [id], onDelete: Restrict)
  rules                SettlementRevenueShareRule[]
  periods              SettlementPeriod[]

  @@index([organizationId, status, createdAt])
}

model SettlementRevenueShareRule {
  id              String              @id @default(cuid())
  agreementId     String
  productCategory String
  shareBps        Int
  tierConfig      Json?
  minCents        Int                 @default(0)
  maxCents        Int?
  createdAt       DateTime            @default(now())
  agreement       SettlementAgreement @relation(fields: [agreementId], references: [id], onDelete: Cascade)

  @@index([agreementId, productCategory, createdAt])
}

model SettlementPeriod {
  id             String               @id @default(cuid())
  organizationId String
  agreementId    String
  periodStart    DateTime
  periodEnd      DateTime
  status         SettlementPeriodStatus @default(draft)
  holdReason     String?
  reviewedAt     DateTime?
  approvedAt     DateTime?
  reconciledAt   DateTime?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  organization   Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  agreement      SettlementAgreement  @relation(fields: [agreementId], references: [id], onDelete: Cascade)
  accrualEntries SettlementAccrualEntry[]
  adjustmentEntries SettlementAdjustmentEntry[] @relation("SettlementAdjustmentBasePeriod")
  appliedAdjustments SettlementAdjustmentEntry[] @relation("SettlementAdjustmentAppliedPeriod")
  statement      SettlementStatement?
  payout         SettlementPayoutInstruction?

  @@index([organizationId, status, periodStart, periodEnd])
}

model SettlementAccrualEntry {
  id              String            @id @default(cuid())
  periodId        String
  organizationId  String
  sourceEntityType String
  sourceEntityId  String
  grossCents      Int
  netCents        Int
  feeCents        Int               @default(0)
  taxCents        Int               @default(0)
  chargebackCents Int               @default(0)
  partnerShareCents Int
  currency        String            @default("USD")
  createdAt       DateTime          @default(now())
  period          SettlementPeriod  @relation(fields: [periodId], references: [id], onDelete: Cascade)
  organization    Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([periodId, createdAt])
  @@index([organizationId, sourceEntityType, sourceEntityId])
}

model SettlementAdjustmentEntry {
  id               String            @id @default(cuid())
  periodId         String
  organizationId   String
  amountCents      Int
  reasonCode       String
  note             String?
  carryForward     Boolean           @default(false)
  appliedToPeriodId String?
  createdAt        DateTime          @default(now())
  period           SettlementPeriod  @relation("SettlementAdjustmentBasePeriod", fields: [periodId], references: [id], onDelete: Cascade)
  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  appliedToPeriod  SettlementPeriod? @relation("SettlementAdjustmentAppliedPeriod", fields: [appliedToPeriodId], references: [id], onDelete: SetNull)

  @@index([periodId, createdAt])
  @@index([organizationId, carryForward, appliedToPeriodId])
}

model SettlementStatement {
  id                  String             @id @default(cuid())
  periodId            String             @unique
  organizationId      String
  totalAccruedCents   Int
  totalAdjustmentsCents Int
  totalPayableCents   Int
  snapshot            Json
  approvedByUserId    String?
  approvedAt          DateTime?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  period              SettlementPeriod   @relation(fields: [periodId], references: [id], onDelete: Cascade)
  organization        Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  approvedBy          User?              @relation(fields: [approvedByUserId], references: [id], onDelete: SetNull)
  payout              SettlementPayoutInstruction?

  @@index([organizationId, createdAt])
}

model SettlementPayoutInstruction {
  id              String              @id @default(cuid())
  periodId        String              @unique
  statementId     String?             @unique
  organizationId  String
  amountCents     Int
  currency        String              @default("USD")
  status          SettlementPayoutStatus @default(pending)
  payoutReference String?
  paidAt          DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  period          SettlementPeriod    @relation(fields: [periodId], references: [id], onDelete: Cascade)
  statement       SettlementStatement? @relation(fields: [statementId], references: [id], onDelete: SetNull)
  organization    Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, status, createdAt])
}

model StrategicMetricDefinition {
  id             String                   @id @default(cuid())
  organizationId String
  metricKey      String
  title          String
  kind           StrategicMetricKind
  owner          String
  guardrail      String?
  status         StrategicDefinitionStatus @default(active)
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt
  organization   Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  versions       StrategicMetricDefinitionVersion[]
  scorecardMetrics StrategicScorecardMetric[]

  @@unique([organizationId, metricKey])
  @@index([organizationId, kind, status, createdAt])
}

model StrategicMetricDefinitionVersion {
  id               String                   @id @default(cuid())
  definitionId     String
  versionNumber    Int
  formula          String
  targetValue      Float
  changeReason     String?
  approvedByUserId String?
  createdAt        DateTime                 @default(now())
  definition       StrategicMetricDefinition @relation(fields: [definitionId], references: [id], onDelete: Cascade)
  approvedBy       User?                    @relation(fields: [approvedByUserId], references: [id], onDelete: SetNull)
  scorecardMetrics StrategicScorecardMetric[]

  @@unique([definitionId, versionNumber])
  @@index([definitionId, createdAt])
}

model StrategicScorecard {
  id                String                 @id @default(cuid())
  organizationId    String
  frequency         String
  periodStart       DateTime
  periodEnd         DateTime
  generatedAt       DateTime               @default(now())
  northStarMetricKey String
  onTrack           Boolean                @default(true)
  confidence        Float                  @default(0.5)
  summary           Json?
  organization      Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  metrics           StrategicScorecardMetric[]

  @@index([organizationId, frequency, generatedAt])
}

model StrategicScorecardMetric {
  id                  String                        @id @default(cuid())
  scorecardId         String
  definitionId        String
  definitionVersionId String
  metricKey           String
  value               Float
  targetValue         Float
  variance            Float
  confidence          Float
  anomaly             Boolean                       @default(false)
  commentary          String?
  createdAt           DateTime                      @default(now())
  scorecard           StrategicScorecard            @relation(fields: [scorecardId], references: [id], onDelete: Cascade)
  definition          StrategicMetricDefinition     @relation(fields: [definitionId], references: [id], onDelete: Restrict)
  definitionVersion   StrategicMetricDefinitionVersion @relation(fields: [definitionVersionId], references: [id], onDelete: Restrict)
  experimentImpacts   StrategicExperimentImpact[]

  @@index([scorecardId, metricKey])
  @@index([definitionId, createdAt])
}

model StrategicExperimentImpact {
  id                String                 @id @default(cuid())
  scorecardMetricId String
  experimentId      String
  preWindowValue    Float
  postWindowValue   Float
  deltaValue        Float
  notes             String?
  createdAt         DateTime               @default(now())
  scorecardMetric   StrategicScorecardMetric @relation(fields: [scorecardMetricId], references: [id], onDelete: Cascade)

  @@index([scorecardMetricId, experimentId])
}
